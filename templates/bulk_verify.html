<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bulk Email Verifier | SaaS UI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8fafc; }
    .navbar { box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .card { border-radius: 1rem; box-shadow: 0 2px 16px rgba(0,0,0,0.06); }
    .verified { color: #198754; font-weight: bold; }
    .unverified { color: #dc3545; }
    .footer { color: #888; font-size: 0.95em; margin-top: 2rem; text-align: center; }
    #main-content { display: none; }
    #signin-box { display: none; min-height: 300px; align-items: center; justify-content: center; flex-direction: column; text-align: center; }
  </style>
  <!-- Firebase JS SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script>
    window.firebaseConfig = {{ firebase_config|tojson|safe }};
  </script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white mb-4">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">Lead<span class="text-primary">Finder</span></a>
    <div>
      <a href="/" class="btn btn-link">Email Finder</a>
      <a href="/single-verify" class="btn btn-link">Single Email Verify</a>
      <a href="/bulk-verify" class="btn btn-link">Bulk Email Verifier</a>
      <span id="user-info" class="ms-3"></span>
      <button id="login-btn" class="btn btn-outline-primary ms-2">Sign in with Google</button>
      <button id="logout-btn" class="btn btn-outline-secondary ms-2" style="display:none;">Sign Out</button>
    </div>
  </div>
</nav>
<div class="container" style="max-width: 700px;">
  {% if used_rows is defined and row_limit is defined %}
    <div class="alert alert-info mb-3">
      Bulk verify usage: <b>{{ used_rows }}</b> / {{ row_limit }} rows
    </div>
  {% endif %}
  <div id="signin-box" style="display:none; min-height:300px; align-items:center; justify-content:center; flex-direction:column; text-align:center;">
    <div class="card p-4 my-5" style="max-width:350px; margin:auto;">
      <h3 class="mb-3">Sign in to continue</h3>
      <p class="mb-4 text-muted">Please sign in with Google to use the Bulk Email Verifier.</p>
      <button id="center-login-btn" class="btn btn-primary w-100 mb-2">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="height:20px; margin-right:8px; vertical-align:middle;"> Sign in with Google
      </button>
    </div>
  </div>
  <div id="main-content">
    <div id="loading-spinner" style="display:none; text-align:center; margin: 20px 0;">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="mt-2">Processing, please wait...</div>
    </div>
    <div class="card p-4 mb-4">
      <h2 class="mb-4">Bulk Email Verifier</h2>
      <form id="bulk-form" method="POST" enctype="multipart/form-data">
        <div class="mb-3">
          <label class="form-label">Upload CSV or Excel File</label>
          <input type="file" name="file" class="form-control" required>
        </div>
        <button class="btn btn-primary w-100">Upload and Verify</button>
      </form>
    </div>
    <div class="footer">&copy; {{ 2025 }} LeadFinder. All rights reserved.</div>
  </div>
</div>
<script>
  // Firebase Auth logic
  let currentUser = null;
  let idToken = null;
  firebase.initializeApp(window.firebaseConfig);
  const auth = firebase.auth();
  const loginBtn = document.getElementById('login-btn');
  const centerLoginBtn = document.getElementById('center-login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const userInfo = document.getElementById('user-info');
  const mainContent = document.getElementById('main-content');
  const signinBox = document.getElementById('signin-box');
  const loadingSpinner = document.getElementById('loading-spinner');

  function showContent(user) {
    userInfo.textContent = user.displayName + ' (' + user.email + ')';
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    mainContent.style.display = 'block';
    signinBox.style.display = 'none';
  }
  function hideContent() {
    userInfo.textContent = '';
    loginBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
    mainContent.style.display = 'none';
    signinBox.style.display = 'flex';
  }
  function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
  }
  loginBtn.onclick = signInWithGoogle;
  if (centerLoginBtn) centerLoginBtn.onclick = signInWithGoogle;
  logoutBtn.onclick = function() {
    auth.signOut();
  };
  // After login, fetch usage count and update the counter
  async function updateUsageCounter() {
    if (!idToken) return;
    const resp = await fetch(window.location.pathname, {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + idToken }
    });
    if (resp.ok) {
      const html = await resp.text();
      // Parse the returned HTML and update the usage counter
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newCounter = doc.querySelector('.alert.alert-info.mb-3');
      const oldCounter = document.querySelector('.alert.alert-info.mb-3');
      if (newCounter && oldCounter) {
        oldCounter.innerHTML = newCounter.innerHTML;
      }
    }
  }
  auth.onAuthStateChanged(async function(user) {
    if (user) {
      idToken = await user.getIdToken();
      showContent(user);
      updateUsageCounter();
    } else {
      idToken = null;
      hideContent();
    }
  });
  // Attach ID token to all form submissions
  document.addEventListener('submit', function(e) {
    if (!idToken) {
      e.preventDefault();
      alert('You must be signed in to submit.');
      return false;
    }
    const form = e.target;
    if (form.tagName === 'FORM') {
      e.preventDefault();
      loadingSpinner.style.display = 'block';
      fetch(form.action || window.location.pathname, {
        method: form.method,
        body: new FormData(form),
        headers: { 'Authorization': 'Bearer ' + idToken }
      }).then(async resp => {
        let data;
        try { data = await resp.json(); } catch { data = {}; }
        loadingSpinner.style.display = 'none';
        if (resp.ok) {
          // Show results dynamically
          let resultsHtml = '';
          if (data.results && data.results.length > 0) {
            resultsHtml += `<div class="card p-4 mb-4"><h4 class="mb-3">✅ Results</h4><div class="table-responsive"><table class="table table-bordered align-middle"><thead class="table-light"><tr><th>Email</th><th>Status</th></tr></thead><tbody>`;
            for (const row of data.results) {
              resultsHtml += `<tr><td>${row.email}</td><td>${row.status ? '<span class=\'verified\'>✔ Verified</span>' : '<span class=\'unverified\'>✖ Invalid</span>'}</td></tr>`;
            }
            resultsHtml += `</tbody></table></div>`;
            if (data.download_link) {
              resultsHtml += `<p><a href="${data.download_link}" class="btn btn-success" download>⬇️ Download Results as Excel</a></p>`;
            }
            resultsHtml += `</div>`;
          }
          // Insert results after the form
          const mainContent = document.getElementById('main-content');
          let oldResults = mainContent.querySelector('.card.p-4.mb-4 + .card.p-4.mb-4');
          if (oldResults) oldResults.remove();
          mainContent.insertAdjacentHTML('beforeend', resultsHtml);
        } else {
          alert(data.error || 'Submission failed.');
        }
      }).catch(err => {
        loadingSpinner.style.display = 'none';
        alert('Network or server error: ' + err);
      });
    }
  }, true);
</script>
</body>
</html>
